<?xml version="1.0" encoding="UTF-8"?>
<scxml 
    initial="idle" 
    version="1.0" 
    name="server_execute"
    model_src=""
    xmlns="http://www.w3.org/2005/07/scxml">

    <datamodel>
        <!-- ID of the thread instance -->
        <!-- Goal fields -->
        <data id="order" type="int32" expr="0" />
        <!-- Exec fields -->
        <data id="sequence" type="int32[]" expr="Array(50)" />
        <data id="sequence__len" type="int32" expr="0" />
    </datamodel>

    <ros_action_thread action_name="/fibonacci" type="example_interfaces/Fibonacci" n_threads="2" />

    <state id="idle">
        <onentry>
            <assign location="sequence__len" expr="0" />
        </onentry>
        <!-- This will check if the thread_id matches with the request -->
        <ros_action_thread_handle_start action_name="/fibonacci" target="execute">
            <assign location="order" expr="_req.order" />
        </ros_action_thread_handle_start>
    </state>

    <state id="execute">
        <onentry>
            <if cond="sequence__len == 0">
                <assign location="sequence[0]" expr="0" />
            <elseif cond="sequence__len == 1" />
                <assign location="sequence[1]" expr="1" />
            <else />
                <assign location="sequence[sequence__len]" expr="sequence[sequence__len - 1] + sequence[sequence__len - 2]" />
            </if>
            <assign location="sequence__len" expr="sequence__len + 1" />
        </onentry>
        <ros_action_thread_cancel action_name="/fibonacci" target="idle" />
        <transition cond="sequence__len == order + 1" target="idle">
            <!-- Results and feedback ROS tags need to add the thread_id to the fields, too. -->
            <ros_action_succeed action_name="/fibonacci">
                <field name="sequence" expr="sequence" />
                <field name="sequence__len" expr="sequence__len" />
            </ros_action_succeed>
        </transition>
        <transition target="execute">
            <ros_action_feedback action_name="/fibonacci">
                <field name="sequence" expr="sequence" />
                <field name="sequence__len" expr="sequence__len" />
            </ros_action_feedback>
        </transition>
    </state>

</scxml>
