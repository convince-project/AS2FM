<?xml version="1.0" encoding="UTF-8"?>
<scxml
    xmlns="http://www.w3.org/2005/07/scxml"
    initial="wait_for_tick"
    version="1.0"
    name="IfThenElse"
    model_src="https://raw.githubusercontent.com/BehaviorTree/BehaviorTree.CPP/refs/heads/v3.8/src/controls/if_then_else_node.cpp">

    <datamodel>
        <data id="child_idx_" type="int8" expr="0" />
        <!-- TODO: children_count might be autogenerated for BT control nodes -->
        <!-- We expect this to be filled automatically with the n. of children -->
        <data id="children_count_" type="int8" />
        <!-- Consider the n. of children as a BT input port -->
    </datamodel>

    <state id="wait_for_tick">
        <transition event="bt_tick" target="tick_condition_child" cond="child_idx_ == 0"/>
        <transition event="bt_tick" target="tick_exec_child" cond="child_idx_ > 0"/>
    </state>

    <state id="tick_condition_child">
        <onentry>
            <if cond="child_idx_ == 0">
                <tick_child id="child_idx_"/>
                <else />
                <!-- Error! Move to Error state -->
            </if>
        </onentry>
        <get_child_response id="child_idx_" cond="_bt.response == SUCCESS" target="tick_exec_child">
            <assign location="child_idx_" expr="1" />
        </get_child_response>
        <get_child_response id="child_idx_" cond="_bt.response == FAILURE && _children_count==3" target="tick_exec_child">
            <assign location="child_idx_" expr="2" />
        </get_child_response>
        <get_child_response id="child_idx_" cond="_bt.response == FAILURE && _children_count < 3" target="wait_for_tick">
            <send event="bt_failure" />
        </get_child_response>
        <get_child_response id="child_idx_" cond="_bt.response == RUNNING" target="wait_for_tick">
            <send event="bt_running" />
        </get_child_response>
    </state>

    <state id="tick_exec_child">
    <!-- TODO -->
        <onentry>
            <tick_child id="child_idx_"/>
        </onentry>
        <transition event="bt_child_success" target="initial" />
        <transition event="bt_child_failure" target="initial" />
    </state>

</scxml>
